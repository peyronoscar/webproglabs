\documentclass[fleqn, article, a4paper]{memoir}
\usepackage[english]{../latex/selthcsexercise}

\usepackage[utf8]{inputenc}
% Utilities.
\usepackage{graphicx}
\usepackage{url}
\usepackage{soul}
\usepackage{varioref}
\usepackage{nameref}
\usepackage{microtype}

\newcommand{\scode}[1]{\texttt{\small#1}}
\newcommand{\FIXBEFORECODE}{\vspace{-0.5\baselineskip}}
\newcommand{\FIXAFTERCODE}{\vspace{-\baselineskip}}

%---------------------------------------------------------------
\newenvironment{Hemarbete}%
{\begin{Assignments}[H]}{\end{Assignments}}

\newenvironment{Kontrollfragor}%
{\begin{Assignments}[K]\tightlist}{\end{Assignments}}

\newenvironment{Datorarbete}%
{\begin{Assignments}[D]}{\end{Assignments}}

\newenvironment{DatorarbeteCont}%
{\begin{Assignments}[D]\setcounter{Ucount}{\theSavecount}}{\end{Assignments}}

\newenvironment{Deluppgifter}%
{\begin{enumerate}[a)]\firmlist}{\end{enumerate}}


\newcommand{\commandchar}[1]{\textsc{#1}}

% Section styles.
\setsecheadstyle{\huge\sffamily\bfseries\raggedright} 
\setsubsecheadstyle{\Large\sffamily\bfseries\raggedright} 
\setsubsubsecheadstyle{\normalsize\sffamily\bfseries\raggedright} 

\setsecnumformat{} % numrera inte laborationerna
\renewcommand{\thesection}{\arabic{section}} % fÃ¶r referenser till laborationerna
\renewcommand{\thefigure}{\arabic{figure}}

%*****************************************************************
\begin{document}
\courseinfo{Web Programming}{\the\year}
\maketitle
\thispagestyle{titlepage}
\vspace{-4cm}

\subsection*{Lab 3}

\n The third lab is about routing and form validation, \emph{objectives}:

\begin{enumerate}\firmlist
\item Understanding how a React application is loaded by the browser.
\item Understanding how a web application can be split into different pages using the React router.
\item Get experience with passing props between components and combining them with parameters from the url.
\item Get some experience with form validation and the html 5 form validation api.
\end{enumerate}

%\clearpage
\subsection*{Background}

The assignments here assumes you have a working solution for lab 2, i.e. a working react app with three components: \code{App}, \code{ComposeSalad}, and \code{ViewOrder}.

\subsection*{Assignments}

\begin{Assignments}

\item We are going to move the \code{ComposeSalad} and \code{ViewOrder} to separate pages in the application. First, make sure you know what a router is and the basics of the react router, for example by reading the official tutorial: 
\\ \url{https://reactrouter.com/docs/en/v6/getting-started/tutorial}

\item We will use the react router. Add it to your project using npm and start the development web server, in the terminal (press \code{ctrl-c} first, if you are running the development web server from lab 2):
\begin{Code}
> npm install react-router-dom
> npm start
\end{Code}

\item All React router components, for example \code{<Link> and <Route>}, must be a child of a router, we will use \code{BrowserRouter} in this lab. To ensur that nothing ends up outside the router by mistake we can add the \code{BrowserRouter} to the top of the React component tree. But where is that? How is \code{<App>} instantiated? To answer these questions lets see what happens when the browser loads your app. It will fetch default file from the servers root, which by default on most servers is a file called  \code{index.html}. There is a \code{public/index.html} file in your project. When you open it, there is no mention of \code{<App>}, just a \code{<div id="root">}. Change the the page title (\code{<title>React App</title>}), or add some html to the page, save it. Look in the browser and you see that the title in the tab changes so this is the file viewed. If you open the development tools and view the source file it looks similar, but with one important addition: \code{<script defer src="/static/js/bundle.js"></script></head>}. This is the works of the React tool chain and \code{bundle.js} contains all the from your project. Specifically, it will include \code{src/index.js}. Open it and you will find code that adds \code{App} to the DOM. Add a \code{<BrowserRouter>} here:

\begin{Code}
import { BrowserRouter } from "react-router-dom";
ReactDOM.render(
  <React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>,
  document.getElementById('root')
);
\end{Code}

\noindent \emph{Reflection question 1:} How do you replace the application icon, \code{favicon.ico}?

\item Next up is a navigation bar. Let's place it in \code{App}, between the header and the salad bar components. It is a good idea to clean up the render function before it gets too complex. The html/JSX code quickly becomes hard to read when it grows, especially when you add wrapping \code{<div>} elements for styling. It is a good idea to separate the different parts of the page to separate React function components. If there are many dependencies to the component state you can move the code to functions inside the class. When adding a new portion to a page, it is good practice to place that part in a separate render function. This is what i have after adding an empty placeholder for the navigation bar:


\begin{Code}
class App {
  render() {
    return (
        <div className="container py-4">
          <Header />
          <Navbar />
          {this.renderPageContent()}
          <Footer />
        </div>
  );}
  
  renderPageContent(){
     <ViewOrder order={this.state.order} />
     <ComposeSalad inventory={inventory} orderSalad={this.orderSalad} />
    return (
    );
  }
}

function Header() {
  return (
    <header className="pb-3 mb-4 border-bottom">
      <span className="fs-4">Min egen salladsbar</span>
    </header>
  );
}
\end{Code}

\noindent When using the React router you use the \code{<Link to="my-path">} elements for the user to click on to navigate in your app, similar to native \code{<a href="my-path">} html elements in static web pages. What about universal design? Do not worry, all the right \code{aria-*} attributes et.c. are set so screen readers know these are navigation elements. Use bootstrap classes to style the links, see \url{https://getbootstrap.com/docs/5.1/components/navs-tabs/}. Bellow is the example code adapted for the react router:
\\ \emph{Option:} If you want a responsive design where the menu collapse to an icon on small screens, use navbar \url{https://getbootstrap.com/docs/5.1/components/navbar/}.

\begin{Code}
function Navbar() {
  return (
  <ul className="nav nav-tabs">
    <li className="nav-item">
      <Link className="nav-link" to="/compose-salad">
        Komponera en sallad
      </Link>
    </li>
    {/* more links */}
  </ul>);
}
\end{Code}
Dod you notice that the paths are hyphen separated word ("compose-salad"). This is by tradition for urls, which we will discuss later in the course. Add a second link for the \code{ViewOrder} page. Go to your browser and klick on the links. The path in your browser changes (url), the selected page is highlighted in the menu, and you use the browser back icon to go to the previous page. However, all pages look the same.

\noindent \emph{Reflection Question 2:} If you use \code{nav-pills} instead of \code{nav-tabs} the selected page is no longer highlighted in the menu, why? \emph{Hint:} \code{<NavLink>} and the \code{active} css class.

\item Let's render the page content based on the navigation bar selection, either the \code{ComposeSalad}, or the \code{ViewOrder} component. For this you use \code{<Routes>} and \code{<Route>}. If you followed my code clean up advice above you should replace \code{this.renderPageContent()} with \code{this.renderRouter()} and place your router code in this function. Your solution should handle four cases:
\\ \code{http://localhost:3000/compose-salad} $\rightarrow$ render the \code{ComposeSalad} component
\\ \code{http://localhost:3000/view-order} $\rightarrow$ render the \code{ViewOrder} component
\\ \code{http://localhost:3000/} $\rightarrow$ This is the first page of your app, render a welcome message. (You can also add a home link in the menu) \emph{hint:} \code{index} attribute
\\ \code{http://localhost:3000/other-stuff} $\rightarrow$ all other urls, render a ``page not found'' message. \emph{hint:} \code{path="*"}

\item Now you should have a working app with two components. Try to order a salad and then switch to the view order page. This user experience is not so good. When the customer order a salad they only see an empty form, no confirmation. Fix this by jumping to the view order page on a successful form submit. Read about navigating programmatically at \url{https://reactrouter.com/docs/en/v6/getting-started/tutorial#navigating-programmatically}. React router hooks can only be used in functional components, so you can not use \code{useNavigate()} in your \code{ComposeSalad} class. This can be solved using higher order components, see \url{https://reactjs.org/docs/higher-order-components.html#convention-pass-unrelated-props-through-to-the-wrapped-component}. Here is a wrapper:
\begin{Code}
import { useNavigate } from "react-router-dom";
import ComposeSalad from './ComposeSalad';

function ComposeSaladWrapper(props){
  const navigate = useNavigate();
  return (
    <ComposeSalad navigate={navigate} {...props}/>
  );
}
export default ComposeSaladWrapper;
\end{Code}
\noindent Update \code{ComposeSalad} so it jumps to the view order page when a salad is ordered.


\item Create a component, \code{ViewIngredient}, that shows the information from the \code{inventory} object about an ingredient, i.e vegan, lactose et.c. You should be able to navigate to the \code{ViewIngredient} component by clicking on the extras in the \code{ComposeSalad} component. To solv this, you should:

\begin{itemize}
  \item Add a \code{<Link ...>} around each ingredient name in \code{ComposeSalad}.
  \item Create a functional component: \code{ViewIngredient}. The ingredient name can be found in the params. Pass \code{inventory} to it as a prop.
  \item Add \code{<Route path='/view-ingredient/:name' ...>} to your router.
\end{itemize}

\noindent \emph{Reflection Question 3:} What is the difference between \code{<Link to="/view-ingredient/:name"} and \code{<Link to="view-ingredient/:name"}. Try it, look in the browser url field.

\emph{Oprional assignemnt:} Add a "view info" button next to the select dropdowns. When the user clicks on it, jump to the \code{view-ingredient} page for the selected ingredient.

\emph{Note:} If you return to the \code{compose-salad} page after viewing the info about an ingredient the form will be empty. This is because React will create a new \code{ComposeSalad} object when you navigate to the page (even if you use the browser history). Consequently any earlier state is lost. Normally you would use pop-ups to show the ingredient info, but here I want you to get experience using router params.

\item Now your app is split to different pages, where each page have a clear functionality. This is good, do not confuse the user by putting too many unrelated things on one page. Let's move on to another important part of the user experience, form validation and feedback. When a user orders a salad we want to make sure that:
\begin{itemize}
  \item one foundation is selected
  \item one protein is selected
  \item one dressing is selected
\end{itemize}
If these conditions are not met, an error message should be displayed and the form submission should stop. We will use html 5 form validation, which have a set of predefined constraints. One of them is \code{required}, which ensures that a value is provided for the form field. Html is text, and the default action is to send a http request, which is also text based, so in this context ``a value'' means anything but the empty string. Remember, the empty sting is falsy in JavaScript. First, add \code{required} to the \code{<select>} fields. To test error handling with select fields, make sure that there is an invalid selection (\code{<option value="">}) and that your component form state is set to an empty sting in the constructor and after form submission.
\begin{Code}
<select required ...>
  <option value=''>make a choice...</option>
  ... more options
</select>
\end{Code}
Now press the submit button. You should get an error message from your browser. Let's replace this your own error message and style it with bootstrap. There are two css classes in bootstrap for this: \code{valid-feedback}, and \code{invalid-feedback}. They can be used on a text element, for example \code{<div>} to show messages. The \code{<div>} should be sibling to the form field (\code{<select>}). The bootstrap css class will hide the element until any of the pseudo classes \code{:valid} or \code{:invalid} is set for the form input field and the css class \code{was-validated} is set on any parent element. We do not want to show error messages for fields the user have not interacted with, so set the \code{was-validated} in your \code{handleChange} or \code{handleSubmit} functions:
\begin{Code}
handleChange(event) {
  event.target.parentElement.classList.add("was-validated");
  // ...
}
handleSubmit(event){
  event.preventDefault();
  event.target.classList.add("was-validated");
  // ...
}
\end{Code}
If you only want to show error messages when the form is submitted, you skip the part in \code{handleChange}. Note, in \code{handleChange}, \code{event} points to the \code{<select>} element, but we want to update the style for parent \code{<div>} element. Hence the \code{parentElement}. Next, add an error message to your \code{<select>} fields. This adds your custom error messages. There is one more thing you need to do, remove the browser error messages:
\begin{Code}
<form onSubmit={this.handleSubmit} noValidate>
\end{Code}
The attribute noValidate tells the browser not to show its own error message. The browser still does html 5 form validation and updates the pseudo classes \code{:valid/:invalid}. You can check if a form is valid by calling \code{formElement.checkValidity()} on the form element, in \code{handleSubmit}:
\begin{Code}
if(event.target.checkValidity() === false){ ... }
\end{Code}

\item \emph{Optional assignment 3}: Add validation of the following constraint:
\begin{itemize}
  \item at least three, but not more than nine extras are selected
\end{itemize}
This error is not related to a single input, but rather a group of checkboxes. It is not a good idea to write an error message on each checkbox, rater add an alert box below the group headline, see \url{https://getbootstrap.com/docs/5.1/components/alerts/}. You can check the constraint in your \code{handleChange} and \code{handleSubmit} functions and store the result in the state:
\begin{Code}
constructor(props) {
  super(props);
  this.state = {
    formErrors: {
      ignoreInvalid: false,
      extras: false,
    }
  };
}
\end{Code}
Use this part of the component state to show and hide your alert boxes. Do not bother the user with an error when the first extra is selected. Wait until the form is submitted. After a failed submission, you want to clear the error as soon as the problem is fixed. The attribute \code{ignoreInvalid} can be used for this, or you might prefer to call it \code{submissionFailed}.

\end{Assignments}

\input{../prechapters/licence-contributors.tex}

\end{document}11